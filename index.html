<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Mengajar SMPIT Al-Kautsar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* SAMA SEPERTI YANG LAMA, TAPI SAYA RAPIKAN UNTUK GITHUB */
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --accent: #0284c7; --text-main: #334155; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); padding: 20px 10px; display: flex; justify-content: center; }
        .container { background: var(--card-bg); width: 100%; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 80px; }
        .header { background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%); padding: 25px; text-align: center; color: white; }
        .header h2 { margin: 0; }
        .form-area { padding: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .cb-item label { display: block; text-align: center; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
        .cb-item input:checked + label { background: var(--accent); color: white; }
        .cb-item input { display: none; }
        .student-card { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .btn-submit { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>JURNAL MENGAJAR</h2>
        <p>SMP IT Al-Kautsar</p>
    </div>

    <form id="jurnalForm" class="form-area">
        
        <div class="input-group">
            <label>Nama Guru</label>
            <select id="guru" class="form-control" required><option>Loading...</option></select>
        </div>

        <div class="input-group">
            <label>Mata Pelajaran</label>
            <select id="mapel" class="form-control" required><option>Loading...</option></select>
        </div>

        <div class="input-group">
            <label>Pilih Kelas</label>
            <select id="kelas" class="form-control" required onchange="loadSiswa()"><option>Loading...</option></select>
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="input-group" style="flex:1">
                <label>Pertemuan Ke</label>
                <input type="number" id="pertemuan" class="form-control" required>
            </div>
            <div class="input-group" style="flex:1">
                <label>Media</label>
                <select id="media" class="form-control">
                    <option>LCD Proyektor</option><option>Papan Tulis</option><option>Lainnya</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <label>Materi</label>
            <input type="text" id="materi" class="form-control" required>
        </div>

        <div class="input-group">
            <label>Kegiatan</label>
            <textarea id="kegiatan" class="form-control" rows="3"></textarea>
        </div>

        <div class="input-group">
            <label>Jam Ke</label>
            <div class="checkbox-grid">
                <script>
                    for(let i=1; i<=10; i++){
                        document.write(`<div class="cb-item"><input type="checkbox" name="waktu" value="${i}" id="j${i}"><label for="j${i}">${i}</label></div>`);
                    }
                </script>
            </div>
        </div>

        <div class="input-group">
            <label>Bukti KBM (Foto)</label>
            <input type="file" id="buktiKBM" class="form-control" accept="image/*" required>
        </div>

        <div class="input-group">
            <label>Catatan</label>
            <input type="text" id="catatan" class="form-control">
        </div>

        <div style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 20px;">
            <h4 style="margin: 0 0 15px 0; color: var(--accent)">Presensi Siswa</h4>
            <div id="loading-siswa" style="display:none; text-align:center;">Mengambil data...</div>
            <div id="student-list" style="text-align: center; color: #999;">Pilih kelas dulu</div>
        </div>

        <br>
        <button type="button" class="btn-submit" onclick="kirimData()" id="btnKirim">KIRIM JURNAL</button>

    </form>
</div>

<script>
    // --- GANTI URL DI BAWAH INI DENGAN URL DEPLOY ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzG4ZKJCOxEmjU12FaVpQ6szU9xvXJnAj4tNy4lpSlsq6FbMwo8doFme-UG-38V8x6D/exec"; 

    // 1. Load Data Awal (Guru/Mapel) saat web dibuka
    window.onload = function() {
        fetch(SCRIPT_URL + "?action=getMeta")
        .then(res => res.json())
        .then(data => {
            isiSelect('guru', data.gurus);
            isiSelect('mapel', data.mapels);
            isiSelect('kelas', data.kelas);
        });
    };

    function isiSelect(id, array) {
        let el = document.getElementById(id);
        el.innerHTML = `<option value="" disabled selected>-- Pilih --</option>`;
        array.forEach(item => {
            let opt = document.createElement('option');
            opt.value = item;
            opt.innerText = item;
            el.appendChild(opt);
        });
    }

    // 2. Load Siswa saat pilih Kelas
    function loadSiswa() {
        let kls = document.getElementById('kelas').value;
        document.getElementById('loading-siswa').style.display = 'block';
        document.getElementById('student-list').innerHTML = '';

        fetch(SCRIPT_URL + "?action=getSiswa&kelas=" + kls)
        .then(res => res.json())
        .then(siswa => {
            document.getElementById('loading-siswa').style.display = 'none';
            let html = '';
            siswa.forEach(nama => {
                html += `
                <div class="student-card">
                    <span style="font-weight:600; font-size:14px">${nama}</span>
                    <select class="absen-select" data-nama="${nama}" style="padding:5px;">
                        <option value="Hadir">‚úÖ H</option>
                        <option value="Sakit">ü§í S</option>
                        <option value="Izin">üì© I</option>
                        <option value="Alpha">‚ùå A</option>
                    </select>
                </div>`;
            });
            document.getElementById('student-list').innerHTML = html;
        });
    }

    // 3. Kirim Data
    function kirimData() {
        if(!confirm('Kirim Data?')) return;

        let btn = document.getElementById('btnKirim');
        btn.innerHTML = 'MENGIRIM...';
        btn.disabled = true;

        // Ambil Nilai Form Manual
        let data = {
            guru: document.getElementById('guru').value,
            mapel: document.getElementById('mapel').value,
            kelas: document.getElementById('kelas').value,
            pertemuan: document.getElementById('pertemuan').value,
            media: document.getElementById('media').value,
            materi: document.getElementById('materi').value,
            kegiatan: document.getElementById('kegiatan').value,
            catatan: document.getElementById('catatan').value,
            waktu: [],
            absensiData: []
        };

        // Ambil Checkbox Waktu
        document.querySelectorAll('input[name="waktu"]:checked').forEach(cb => data.waktu.push(cb.value));

        // Ambil Absensi
        document.querySelectorAll('.absen-select').forEach(sel => {
            data.absensiData.push({ nama: sel.getAttribute('data-nama'), status: sel.value });
        });

        // Proses File & Kirim
        let fileInput = document.getElementById('buktiKBM');
        if(fileInput.files.length > 0) {
            let reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);
            reader.onload = function(e) {
                data.fileData = reader.result.split(',')[1]; // Ambil base64 murni
                data.fileName = fileInput.files[0].name;
                data.mimeType = fileInput.files[0].type;
                
                kirimKeGoogle(data, btn);
            }
        } else {
            alert("Wajib upload foto!");
            btn.innerHTML = "KIRIM JURNAL";
            btn.disabled = false;
        }
    }

    function kirimKeGoogle(payload, btn) {
        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(response => {
            if(response.status == 'success') {
                alert("‚úÖ Berhasil Tersimpan!");
                location.reload();
            } else {
                alert("‚ùå Gagal: " + response.message);
            }
            btn.innerHTML = "KIRIM JURNAL";
            btn.disabled = false;
        })
        .catch(err => {
            alert("Error Jaringan/CORS. Cek Console.");
            console.log(err);
            btn.disabled = false;
        });
    }
</script>

</body>
</html>
